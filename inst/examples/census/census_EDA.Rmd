---
title: "Census Data Analysis"
output: html_notebook
---

# Overview

Predict whether income exceeds $50K/yr based on census data. Also known as "Adult" dataset.

* 1994 Study
* [Tensorflow](https://www.tensorflow.org/tutorials/wide)
* [Data source](https://archive.ics.uci.edu/ml/datasets/Census+Income)
* [Data description](https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.names)

# Outline

* an Rmd for visualizations/EDA of the raw dataset
* then perhaps an Rmd making predictions
* then perhaps a Shiny app making predictions

# Notes
* it would be cool if we used plotly as that would give us some very nice interactive artifcats
* Important: The training in the demo will occur as an async cloudml job rather than something that happens inline in an Rmd.
* The big drivers are: marital status, education, and sex

```{r setup, message=FALSE}
library(tidyverse)
library(plotly)
library(pROC)
library(glmnet)
```

# Download

```{r, eval=FALSE}
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.data", "train_file")
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.test", "test_file")

#download.file("http://mlr.cs.umass.edu/ml/machine-learning-databases/adult/adult.data", "train_file")
#download.file("http://mlr.cs.umass.edu/ml/machine-learning-databases/adult/adult.test", "test_file")
```

# Read Data

```{r, message=FALSE}
col_names = c(
  "age", "workclass", "fnlwgt", "education", "education_num",
  "marital_status", "occupation", "relationship", "race", "gender",
  "capital_gain", "capital_loss", "hours_per_week", "native_country",
  "income_bracket"
)

train_raw <- read_csv("train_file", col_names = col_names, na = "?")
test_raw  <- read_csv("test_file", col_names = col_names, na = "?", skip = 1)
```

# Create modeling data

```{r}
format.rawdata <- function(data){
  data %>%
    mutate(label = ifelse(income_bracket == ">50K" | income_bracket == ">50K.", 1, 0)) %>%
    mutate(age_buckets = cut(age, c(16, 18, 25, 30, 35, 40, 45, 50, 55, 60, 65, 90))) %>%
    select(label, gender, native_country, education, education_num, occupation, workclass, marital_status, 
           race, age_buckets) %>%
    na.omit
}

create.interactions <- function(data){
  data %>%
    mutate(education_x_occupation = paste(education, occupation, sep = ":")) %>%
    mutate(age_buckets_x_education_x_occupation = paste(age_buckets, education, occupation, sep = ":"))
}

train <- train_raw %>% format.rawdata #%>% create.interactions
test  <- test_raw  %>% format.rawdata #%>% create.interactions
```

# Plot categorical columns

* workclass
* education
* marital_status
* occupation
* relationship
* race
* gender
* native_country

```{r}
plot.main.effects <- function(data, x, y){
  p <- data %>%
    mutate_(group = x, metric = y) %>%
    group_by(group) %>%
    summarize(percent = 100 * mean(metric)) %>%
    ggplot(aes(x = reorder(group, percent), percent)) +
    geom_bar(stat="identity") +
    coord_flip() +
    labs(y = "Percent", x = "") +
    ggtitle(paste("Percent surveyed with incomes over $50k by", x))
  ggplotly(p)
}

plot.main.effects(train, "marital_status", "label")
plot.main.effects(train, "gender", "label")
plot.main.effects(train, "education", "label")
```

# Plot continuous columns

* age
* education_num
* capital_gain
* capital_loss
* hours_per_week

```{r}
train_raw %>%
  na.omit %>%
  select(income_bracket, age, education_num, capital_gain, capital_loss, hours_per_week) %>%
  gather(column, val, -income_bracket) %>%
  filter(column == "age") %>%
  ggplot(aes(val, fill = income_bracket)) + geom_density()

plot.continuous <- function(data, x, y, alpha = 0.2, ...){
  data %>%
    select_(groups = x, y = y) %>%
    na.omit %>%
    ggplot(aes(y, fill = groups)) + geom_density(alpha = alpha, ...) +
    labs(x = y, y = "") +
    ggtitle(paste(y, "by", x))
}

# People who earn more also work more, are better educated, and are older
plot.continuous(train_raw, "income_bracket", "age")
plot.continuous(train_raw, "income_bracket", "education_num", adjust = 5)
plot.continuous(train_raw, "income_bracket", "hours_per_week", adjust = 5)

```


# Plot interactions

```{r}
p <- train %>%
  select(education_num, age_buckets, label) %>%
  group_by(age_buckets, education_num) %>%
  summarize(percent = 100 * mean(label)) %>%
  ggplot(aes(education_num, age_buckets, fill = percent)) +
  geom_tile() +
  labs(x = "Education", y = "Age") +
  ggtitle("Percent surveyed with incomes over $50k by age, education")
ggplotly(p)

p <- train %>%
  select(age_buckets, education_num, occupation, label) %>%
  group_by(age_buckets, education_num, occupation) %>%
  summarize(percent = 100 * mean(label)) %>%
  ggplot(aes(education_num, age_buckets, fill = percent)) +
  geom_tile() +
  facet_wrap( ~ occupation) +
  labs(x = "Education", y = "Age") +
  ggtitle("Percent surveyed with incomes over $50k by age, education, and occupation")
ggplotly(p)

```

## Train Model

Gender, education, and marital status are all highly significant. Marrital status in particular is a good predictor of those earning more than $50k.

```{r}
m1 <- glm(label ~ gender + native_country + education + occupation + workclass + marital_status +  
         race + age_buckets, binomial, train)
summary(m1)
#anova(m1) # takes a while to run
plot(m1)
```

## Predict

The high area under the curve (AUC) of 0.883 is an indicator that this model is probably overfitting. 

```{r}
test %>%
  mutate(pred = predict(m1, ., type = "response")) %>%
  roc(label ~ pred, .) %>%
  plot.roc(., print.auc = TRUE) # maybe add accuracy like the TF example
```

## Regularize

Fit an elastic net (regularized) model that includes L1 and L2 penalties.

```{r}
# Convert to factors
alldata <- bind_rows("train" = train, "test" = test, .id = "data") %>%
  select(-education_num) %>%
  mutate_each(., funs(factor(.))) %>%
  model.matrix( ~ ., .)

# Create training prediction matrix
train.factors <- list(x = alldata[alldata[,'datatrain'] == 1, -(1:3)],
                     y = alldata[alldata[,'datatrain'] == 1, 3])

# Create test prediction matrix
test.factors <- list(x = alldata[alldata[,'datatrain'] == 0, -(1:3)],
                    y = alldata[alldata[,'datatrain'] == 0, 3])

# Fit a regularized model
fit1 <- glmnet(train.factors$x, train.factors$y, "binomial")
plot(fit1)
print(fit1)
coef(fit1, s = 0.03) # extract coefficients at a single value of lambda

# Cross validation (long running for full dataset)
#cvfit <- cv.glmnet(train.factors$x, train.factors$y, family = "binomial", type.measure = "class")
#plot(cvfit)
#cvfit$lambda.min # 0.0001971255

# Predict and plot the AUC
test.factors$pred <- predict.glmnet(fit1, test.factors$x, s=0.02) # make predictions
data.frame(resp = test.factors$y, pred = c(test.factors$pred)) %>%
  roc(resp ~ pred, .) %>%
  plot.roc(., print.auc = TRUE)
```

## Make shiny apps

* Gadget: Calculator that takes the formula only and spits out a prediction.
* App: Training the model based on selected input. Spits out an ROC curve.
* Dashboard: Profiler that helps you understand who is most likely to earn more than $50k

